<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>mailbox.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Classes</li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Endpoint.html">Endpoint</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#.link">link</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#_init_follower">_init_follower</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#_init_leader">_init_leader</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#_send">_send</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#broadcast">broadcast</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#handler">handler</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#init">init</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#onlink">onlink</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#receive">receive</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#toJSON">toJSON</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Endpoint.html#wait">wait</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Mailbox.html">Mailbox</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#clear">clear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#isempty">isempty</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#mails">mails</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#match">match</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#matchany">matchany</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#put">put</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Mailbox.html#toJSON">toJSON</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="MailboxWorker.html">MailboxWorker</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#_condition">_condition</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#_conditions">_conditions</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#dispatch">dispatch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#onclear">onclear</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#onclose">onclose</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#onmatch">onmatch</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="MailboxWorker.html#onput">onput</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Msg.html">Msg</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="SessionEvent.html">SessionEvent</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SessionEvent.html#.Recv">Recv</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="SessionEvent.html#.Send">Send</a></span></li><li class="nav-heading"><span class="nav-item-type type-class">C</span><span class="nav-item-name"><a href="Sock.html">Sock</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Sock.html#bind">bind</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Sock.html#close">close</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Sock.html#connect">connect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Sock.html#disconnect">disconnect</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="Sock.html#send">send</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">mailbox.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict"

const nanomsg = require("nanomsg")
const uuidv4  = require("uuid/v4")

const _      = require("./collections.js")
const Sock   = require("./socket.js")
const Msg    = require("./msg.js")
const Logger = require("./recorder.js")


/**
 * @ignore
 */
const sleep = ms => new Promise((resolve, reject) => setTimeout(resolve, ms))

/**
 * A `MailboxWorker` that actually holds the "concurrent" buffer.
 * 
 * The "concurrency" is achieved by queueing callbacks for mailbox commands
 * like "put" and "match". Many commands may arraive concurrently, but will be
 * serialized by the NodeJS core. Callbacks will then be invoked in order, and 
 * will not be interrupted unless the callback yields at `await`. 
 *
 * @package
 */
class MailboxWorker {

    /**
     * @param  {Mailbox} parent - The owning mailbox.           
     * @param  {String}  addr   - Socket address to connect to.
     * @return {MailboxWorker}
     */
    constructor(parent, addr) {
        /**
         * @type {Mailbox}
         */
        this.parent = parent

        /**
         * @type {Array}
         */
        this.mbox = []

        /**
         * @type {Sock}
         */
        this.sock = new Sock("pair")

        this.sock.connect(addr)
        this.sock.onmessage = msg => this.dispatch(msg)
    }
    
    /**
     * Handles the "put" command.
     * 
     * @param  {Mailbox.Put} msg 
     * @return {Void}
     */
    onput(msg) {
        this.mbox.push(msg.payload)
        Logger.mailbox(this.parent)
    }
    
    /*    
     * @callback Mailbox.Predicate
     * @param  {Msg}  m - The message to check.
     * @return {Boolean} `true` if the message matches the pattern.
     */
    
    /**
     * Build a pattern checking function out of a given example.
     *
     * @protected
     * @param  {Msg} msg  - An example message, showing the label/sender to match.
     * @return {Mailbox.Predicate} 
     */
    _condition(msg) {
        const label  = msg.label
        const sender = msg.sender
        
        if (label &amp;&amp; sender) 
            return m => m.label == label &amp;&amp; m.sender == sender
        else if (label)
            return m => m.label == label 
        else if (sender)
            return m => m.sender == sender
        else 
            throw new Error("No conditions given when trying to match a message from the mailbox.")
    }

    /**
     * Build an alternative patterns checking function out of a list of given examples. 
     *
     * @protected
     * @param  {Array&lt;Msg>} msgs - An array of example messages.
     * @return {Mailbox.Predicate} A function that checks if the message matches any of the patterns.
     */
    _conditions(msgs) {
        const base  = m => false 
        const fn    = (msg, conds) => { return m => this._condition(msg)(m) || conds(m) }
        const conds = msg.payload.foldr(base, fn)

        return conds
    }

    /**
     * Handles "match" command.
     *
     * @param  {Mailbox.Match} msg 
     * @return {Msg} Return the earliest message that matches any of the example messages.      
     */
    async onmatch(msg) {
        const conds = this._conditions(msg.payload)

        while (true) {
            let index = this.mbox.findIndex(conds)
            while (index &lt; 0) {
                await sleep(1)
                index = this.mbox.findIndex(conds)
            }
            
            const ret = this.mbox.splice(index, 1)[0]
            Logger.mailbox(this.parent)
            return ret
        }
    }

    /**
     * Close the mailbox.
     * 
     * @return {Void}
     */
    onclose() {
        delete this.mbox
        this.sock.close()
    }

    /**
     * Clear all the messages that match the pattern.
     * 
     * @param  {Mailbox.Clear} msg
     * @return {Void}
     */
    onclear(msg) {
        const cond = this._condition(msg.payload)
        this.mbox = this.mbox.filter(m => !cond(m))

        Logger.mailbox(this.parent)
    }

    /**
     * Dispatch commands. 
     *
     * This function "returns" by sending a reply message.
     * 
     * @param  {(Mailbox.Put|Mailbox.Match|Mailbox.Close|Mailbox.Clear|Mailbox.Size)} msg 
     * @return {Void|Msg}
     */
    async dispatch(msg) {
        switch (msg.label) {
            case "put":
                this.onput(msg)
                break
            case "match":
                this.sock.send(await this.onmatch(msg))
                break
            case "close":
                this.onclose()
                break
            case "size":
                this.sock.send(this.mbox.length)
                break
            case "clear":
                this.onclear(msg)
                break
        }
    }
}


/**
 * An Erlang-style concurrent mailbox that supports pattern matching.
 */
class Mailbox {

    /**
     * @param  {Endpoint} ep - The endpoint who owns the mailbox.
     * @return {Mailbox} 
     */
    constructor(ep) {
        /**
         * @type {Endpoint}
         */
        this.endpoint = ep

        /**
         * @type {String}
         */
        this.addr = `inproc://${uuidv4()}`

        /**
         * @type {Sock}
         */
        this.sock = new Sock("pair")
        this.sock.bind(this.addr)

        /**
         * @type {MailboxWorker}
         */
        this.worker = new MailboxWorker(this, this.addr)

        Logger.mailbox(this)
    }

    /**
     * @typedef  {Msg}        Mailbox.Match
     * @property {"match"}    label
     * @property {Array&lt;Msg>} payload - The messages to match.
     */
    
    /** 
     * @typedef  {Msg}   Mailbox.Put
     * @property {"put"} label
     * @property {Msg}   payload - The message to put.
     */
    
    /**
     * @typedef  {Msg}     Mailbox.Clear
     * @property {"clear"} label
     * @property {Msg}     payload - The message to match and clear.
     */
    
    /**
     * @typedef  {Msg}    Mailbox.Size
     * @property {"size"} label
     */
    
    /**
     * @typedef  {Msg}     Mailbox.Close
     * @property {"close"} label
     */

    /**
     * Put a message into the mailbox.
     * 
     * @param  {Msg}  msg 
     * @return {Void}     
     */
    put(msg) {
        this.sock.send(new Msg("put", null, msg))
    }

    /**
     * Get the earliest message that matches the given example.
     * The example message will show the intended label and/or sender.
     *
     * @async
     * @param  {Msg} msg - An example message showing the intended label and/or sender.
     * @return {Msg} 
     */
    match(msg) {
        return this.matchany([msg])
    }

    /**
     * Get the earliest message that matches one of the given examples. 
     *
     * @async
     * @param  {Array&lt;Msg>} msgs
     * @return {Msg} 
     */
    matchany(msgs) {
        let request = new Promise((resolve, reject) => {
            this.sock.onmessage = msg => resolve(msg)
            this.sock.send(new Msg("match", null, msgs))
        })

        return request
    }

    /**
     * Delete all the messages that match the given example.
     * 
     * @param  {Msg}  msg 
     * @return {Void}
     */
    clear(msg) {
        this.sock.send(new Msg("clear", null, msg))
    }

    /**
     * Close the mailbox.
     * 
     * @return {Void}
     */
    close() {
        this.sock.send(new Msg("close", null, null))
        this.sock.close()

        Logger.closemailbox(this)
    }

    /**
     * Check if the mailbox is empty.
     * 
     * @return {Boolean} `true` if the mailbox is empty, `false` otherwise.
     */
    isempty() {
        return new Promise((resolve, reject) => {
            this.sock.onmessage = msg => resolve(msg == 0)
            this.sock.send(new Msg("size", null, null))            
        })
    }

    /**
     * Get a copy of all the mails in the mailbox.
     * 
     * @return {Array&lt;Msg>}
     */
    mails() {
        return this.worker.mbox.clone()
    }
    
    /**
     * @typedef  {Object} Mailbox.JSON
     * @property {String} id       - The address of the mailbox, which is uniquely generated as an uuid.
     * @property {uuid}   endpoint - The id of the owning endpoint.
     * @property {Array&lt;Msg>} mails
     */
    
    /**
     * @return {Mailbox.JSON}
     */
    toJSON() {
        return {
            id:       this.addr,
            endpoint: this.endpoint.id,
            mails:    this.worker.mbox.clone()
        }
    }

}

module.exports = Mailbox


</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Thu Dec 28 2017 11:24:51 GMT-0500 (EST) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
